var expData,mainData,itemObj=new Array(),classCut=new Array(),tableRow,library,leader,format,classMark,avail,oClass,lkClass,thrClass=0,splitClass=0,newClass,parts,nkClass,str,getExp,locnURL,fullLocn,htmlLocn,leaderTidy;function ItemObj(d,e,b,c,a){this.classM=d;this.format=e;this.library=b;this.leader=c;this.status=a}function ajaxFun(b,a,c){$.ajax({type:"GET",url:b,async:false,jsonpCallback:a,contentType:"application/json",dataType:"jsonp",cache:false,success:function(d){if(c==="expData"){expData=d;ajaxFun("http://libapps.liv.ac.uk/jQuery/library/location/locations.json?callback=?","main","mainData")}else{if(c==="mainData"){mainData=d;itemInfo()}else{console.log("data not set")}}},error:function(d){console.log("error")}})}function itemInfo(){tableRow=$(".bibItems > tbody  > tr");for(i=0;i<tableRow.length;i++){library=$(tableRow[i]).children("td:nth-child(1)");library=$(library).text().trim();leader=$("td .bibInfoLabel:contains('Leader')");leader=$(leader).next().text();format=leader.trim().charAt(7);if(format==="m"){format="monograph"}else{if(format==="s"){format="serial"}}classMark=$(tableRow[i]).children("td:nth-child(2)").text().trim();avail=$(tableRow[i]).children("td:nth-child(3)").text().trim();if(library.length){itemObj.push(new ItemObj(classMark,format,library,leader,avail))}}dispLocn()}function dispLocn(){$.each(itemObj,function(a,b){library=b.library;format=b.format;classMark=b.classM;leaUpdate=b.leader;if(library==="Sydney Jones Library"||library==="Harold Cohen Library"){if(format==="monograph"||format==="serial"){newClass=classMark.split(/\.(?![^\[\]]*\])/);if(newClass[0].match(/^[A-z][A-z][0-9]/)){parts=newClass[0].match(/(\D+)(\d.+)/).slice(1);lkClass=parts[0];nkClass=lkClass.charAt(0);for(i=0;i<=25;i++){str=String.fromCharCode("A".charCodeAt()+i);oClass=nkClass+str;if(expData[library][format][oClass]){classCut.push(expData[library][format][oClass]);break}}}else{if(newClass[0].match(/^[A-z][A-z][A-z]/)){lkClass=String(newClass[0]).substring(0,3);thrClass=String(newClass[0]).substring(0,3)}else{if(newClass[0].match(/^[0-9]/)){lkClass=Number(newClass[0]).toPrecision(1)}}}if(classCut.length<=0){classCut.push(expData[library][format][lkClass])}if(classCut[0]!==undefined){function c(d){$.each(d,function(e,f){if(Number(parts[1])>=Number(f.number)){splitClass=f.newCls}else{if(lkClass>oClass){splitClass=f.newCls}else{splitClass=classMark.charAt(0)}}})}c(classCut)}else{if(classCut[0]===undefined){if(thrClass!==0){splitClass=thrClass}else{splitClass=classMark.charAt(0)}}else{console.log("error")}}locnURL=mainData[library][format][splitClass].locnURL;fullLocn=mainData[library][format][splitClass].fullLocn;htmlLocn=$('a:contains("'+library+'")').parent();leaderTidy=$('tr:contains("Leader")').parent().html();if(fullLocn!==undefined){htmlLocn=$(htmlLocn).html('<a class="fancybox" rel="group" title="Your classmark is '+classMark+'" href="'+locnURL+'">'+library+"<br />"+fullLocn+"</a>");$(".fancybox").fancybox({maxWidth:800,maxHeight:600,fitToView:false,width:"70%",height:"70%",autoSize:false,closeClick:true,openEffect:"none",closeEffect:"none",prevEffect:"none",netxEffect:"none",arrows:false,helpers:{title:{type:"inside"}}})}else{htmlLocn=libUpdate.html('<a href="http://www.liv.ac.uk/library/using/find-things.html">'+library+"</a>")}}}})}$(document).ready(function(){if($("#bibDisplayContent").length){return ajaxFun("http://libapps.liv.ac.uk/jQuery/library/location/locn_except.json?callback=?","exp","expData")}else{return false}});